#### 总览

目前创业管家与汇联易间的接口主要有以下几个：员工、部门、分析方案、分析账户、报销单自动创建凭证、支付，其中除了凭证创建是定时同步外，其他都是即时

#### 一、接口流程

1、汇联易创建公司

2、在设置&gt;连接器&gt;汇联易&gt;后台，创建一个汇联易后台，此后台数据主要是基础的配置，包括如何链接汇联易，链接的用户名和密码，公司的OID，这些数据都是汇联易提供

3、点击初始化按钮，把系统已存在的员工、部门、分析方案、分析账户同步至汇联易，注意：创建的后台只有初始化后才会在修改了数据后实时同步，否则等于后台没启用

![](/assets/backend.png)

4、至此，大概的接口流程就完了，各个子接口下面详细说，下面的接口都是基于后台已经初始化前置条件

#### 

#### 二、任务管理

在设置&gt;连接器&gt;队列任务&gt;任务，可以查看基于queue.job的任务列表，本次接口的任务都可以在此处展示，可以对其进行重置、查看详细报错信息等操作

#### 三、人员

1、触发条件：

* 新建一个员工；
* 删除一个员工；
* 修改员工，修改员工任一下面字段就会触发：department\_id，mobile\_phone，name，work\_email，employee\_number

2、字段映射

| 创业管家 | 汇联易 | 备注 |
| :--- | :--- | :--- |
| name | fullName |  |
| mobile\_phone | mobile |  |
| mobile\_phone | password | 密码只有初次触发时才会同步， 后面的修改同步不会更新汇联易的密码 |
| work\_email | email |  |
| artemis\_company | companyOID | 固定为后台的公司OID |
| employee\_number | employeeID |  |
| department\_id对应的OID | departmentOID | 部门接口中间表的artemis\_id |

#### 

#### 四、部门

1、触发条件：

* 新建一个部门；
* 删除一个部门；
* 修改部门，修改部门任一下面字段就会触发：name，manager\_id，parent\_id

2、字段映射

| 创业管家 | 汇联易 | 备注 |
| :--- | :--- | :--- |
| name | name |  |
| parent\_id对应的OID | parentDepartmentOID | 部门接口中间表的artemis\_id |
| artemis\_company | companyOID | 固定为后台的公司OID |
| manager\_i对应的OID | managerOID | 员工接口中间表的artemis\_id |

#### 

#### 五、分析方案

1、触发条件：

* 分析创建时或修改（涉及字段name）时，hly\_expense值为TRUE触发

2、字段映射

| 创业管家 | 汇联易 | 备注 |
| :--- | :--- | :--- |
| name | name |  |
| TRUE | enabled | 固定为TRUE |

#### 

#### 六、分析账户

1、触发条件：分析账户的接口与分析方案紧密相关，要同步到汇联易的分析账户必须满足两个条件：

* 挂靠的分析方案必须勾选了汇联易，且对应的顶级分析账户也勾选了汇联易；
* 分析账户的类型必须为辅助核算项

2、字段映射

| 创业管家 | 汇联易 | 备注 |
| :--- | :--- | :--- |
| complete\_name | name |  |
| code | code |  |
| active\_flag | enabled |  |
| TRUE | public | 固定为TRUE |



#### 七、报销单凭证创建

该接口是定时拉取汇联易已审批通过的报销单至创业管家生成凭证，间隔十分钟，以ir.cron安排的工作

主要逻辑在于凭证行上的科目、分析分配上的取值，科目和分析分配的取值与分析账户相关，

* 分析账户的费用类型决定了科目取的是管理费用科目还是销售费用科目
* 分析账户决定了分析分配的维度

1、分析账户

一般同步到汇联易的分析账户都是维度为地区、部门、产品的分析方案，维度只传产品

* 部门维度：如果报销单上的部门departmentOID与申请人applicantOID对应的部门是一致的，则取部门上的分析账户，否则则取申请人对应员工的成本中心
* 产品维度：汇联易只有一个成本中心，这个成本中心选择的是产品维度，没有则默认缺省
* 地区维度：报销单明细的departmentOID对应的部门的部门地区分析账户

2、科目的取值：

报销单明细费用类型OID + 部门维度分析账户的费用类型 确定科目，路径：会计&gt;设置&gt;汇联易&gt;科目映射![](/assets/acc_mapping.png)

3、根据1中的各维度的分析账户和2中的科目确定分方案和自动生成分析分配

#### 八、支付

通过上面的凭证接口创建凭证，后续还需要对凭证进行支付，支付动作需要进行两个处理

* 给汇联易发支付消息，更改报销单为已付款
* 回写凭证的贷方科目，更改支付状态为已支付

支付动作可从凭证tree视图上批量支付或form界面单个支付，需要配置支付方式以替换原凭证的贷方科目，路径：会计&gt;设置&gt;汇联易&gt;支付方式

![](/assets/pay_conf.png)

